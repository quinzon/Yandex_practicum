version: '3.8'


x-common-variables: &common-variables
  networks:
    - test-network
  labels:
    com.example.project: "functional-tests"

services:
  api:
    build: ../../
    image: fastapi
    container_name: api_container
    env_file:
      - .env.tests
    entrypoint: ["uvicorn", "src.main:app", "--host", "0.0.0.0", "--port", "8000"]
    <<: *common-variables

  tests:
    image: fastapi
    env_file:
      - .env.tests
    <<: *common-variables
    entrypoint: >
      sh -c "export PYTHONPATH=/opt/app
      && pip install -r /opt/app/tests/functional/requirements.txt
      && python3 /opt/app/tests/functional/utils/wait_for_es.py
      && python3 /opt/app/tests/functional/utils/wait_for_redis.py
      && pytest /opt/app/tests/functional/src"


  redis:
    image: redis:latest
    <<: *common-variables


  elasticsearch:
    image: elasticsearch:8.6.2
    environment:
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
      discovery.type: "single-node"
      xpack.security.enabled: "false"
    <<: *common-variables

networks:
  test-network:
    driver: bridge
